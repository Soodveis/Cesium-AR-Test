<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Магнитная карта в AR</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.109/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.109/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body, #cesiumContainer {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #enterAR {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 100;
      padding: 15px 30px;
      font-size: 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <button id="enterAR">Перейти в AR</button>

  <script>
    window.CESIUM_BASE_URL = "https://cesium.com/downloads/cesiumjs/releases/1.109/Build/Cesium/";
    console.log("Cesium.js загружается...");

    window.onload = async function () {
      try {
        console.log("Цезий загружен");

        Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3YWU5YWQ4Yy04MWJhLTRiMjEtODlhYy1hMzBmMThjZGFlY2YiLCJpZCI6Mjg0NzkyLCJpYXQiOjE3NDMyNDk4OTR9.XYyDBN_rm1I7n7X6iOIYvNpuCOLf9pkRh2b-Hg0XMyU";

        const viewer = new Cesium.Viewer('cesiumContainer', {
          terrainProvider: Cesium.createWorldTerrain(),
          baseLayerPicker: true
        });

        Cesium.IonResource.fromAssetId(3264517)
          .then(resource => Cesium.KmlDataSource.load(resource))
          .then(dataSource => viewer.dataSources.add(dataSource))
          .catch(error => console.error('Ошибка загрузки KML:', error));

        document.getElementById('enterAR').addEventListener('click', async () => {
          try {
            if (!navigator.xr) throw new Error("WebXR не поддерживается браузером");

            const isSupported = await navigator.xr.isSessionSupported('immersive-ar');
            if (!isSupported) throw new Error("WebXR AR не поддерживается");

            const session = await navigator.xr.requestSession('immersive-ar', {
              requiredFeatures: ['local-floor']
            });

            const gl = viewer.scene.canvas.getContext('webgl', { xrCompatible: true });
            await gl.makeXRCompatible?.();
            const xrGlBinding = new XRWebGLLayer(session, gl);

            session.updateRenderState({ baseLayer: xrGlBinding });
            await session.requestReferenceSpace('local-floor');

            const arSquare = document.createElement('div');
            arSquare.style.position = 'absolute';
            arSquare.style.top = '50%';
            arSquare.style.left = '50%';
            arSquare.style.width = '200px';
            arSquare.style.height = '200px';
            arSquare.style.marginTop = '-100px';
            arSquare.style.marginLeft = '-100px';
            arSquare.style.background = 'lime';
            document.body.appendChild(arSquare);

            session.addEventListener('end', () => {
              document.body.removeChild(arSquare);
            });
          } catch (e) {
            alert('Ошибка запуска AR: ' + e.message);
            console.error(e);
          }
        });
      } catch (err) {
        console.error("Ошибка инициализации Cesium:", err);
      }
    }
  </script>
</body>
</html>
