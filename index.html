<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Магнитная карта в AR</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.109/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.109/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body, #cesiumContainer {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #enterAR {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 100;
      padding: 12px 22px;
      font-size: 18px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <button id="enterAR">Перейти в AR</button>

  <script>
    window.CESIUM_BASE_URL = "";
    Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3YWU5YWQ4Yy04MWJhLTRiMjEtODlhYy1hMzBmMThjZGFlY2YiLCJpZCI6Mjg0NzkyLCJpYXQiOjE3NDMyNDk4OTR9.XYyDBN_rm1I7n7X6iOIYvNpuCOLf9pkRh2b-Hg0XMyU";

    async function initCesium() {
      try {
        const terrainResource = await Cesium.IonResource.fromAssetId(1);
        const terrainProvider = new Cesium.CesiumTerrainProvider({ url: terrainResource });

        const viewer = new Cesium.Viewer('cesiumContainer', {
          terrainProvider: terrainProvider,
          baseLayerPicker: true
        });

        // Загрузка KML-магнитной карты
        const kmlResource = await Cesium.IonResource.fromAssetId(3264517);
        const kmlLayer = await Cesium.KmlDataSource.load(kmlResource);
        viewer.dataSources.add(kmlLayer);

        // Обработчик кнопки AR
        document.getElementById('enterAR').addEventListener('click', async () => {
          try {
            const xrSupported = await navigator.xr?.isSessionSupported('immersive-ar');
            if (!xrSupported) throw new Error("WebXR AR не поддерживается");

            const session = await navigator.xr.requestSession('immersive-ar', {
              requiredFeatures: ['local-floor']
            });

            const gl = viewer.scene.canvas.getContext('webgl', { xrCompatible: true });
            const xrGlBinding = new XRWebGLLayer(session, gl);

            session.updateRenderState({ baseLayer: xrGlBinding });
            await session.requestReferenceSpace('local-floor');

            const arSquare = document.createElement('div');
            arSquare.style.position = 'absolute';
            arSquare.style.top = '50%';
            arSquare.style.left = '50%';
            arSquare.style.width = '200px';
            arSquare.style.height = '200px';
            arSquare.style.marginTop = '-100px';
            arSquare.style.marginLeft = '-100px';
            arSquare.style.background = 'lime';
            document.body.appendChild(arSquare);

            session.addEventListener('end', () => {
              document.body.removeChild(arSquare);
            });
          } catch (e) {
            alert('Ошибка запуска AR: ' + e.message);
            console.error(e);
          }
        });

      } catch (err) {
        console.error("Ошибка инициализации Cesium:", err);
      }
    }

    initCesium();
  </script>
</body>
</html>
