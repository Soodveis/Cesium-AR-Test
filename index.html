<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AR Cesium Demo</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.109/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.109/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body, #cesiumContainer {
      width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
    }
    #arButton {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 5;
      padding: 14px 24px;
      font-size: 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <button id="arButton">Перейти в AR</button>

  <script>
    Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3YWU5YWQ4Yy04MWJhLTRiMjEtODlhYy1hMzBmMThjZGFlY2YiLCJpZCI6Mjg0NzkyLCJpYXQiOjE3NDMyNDk4OTR9.XYyDBN_rm1I7n7X6iOIYvNpuCOLf9pkRh2b-Hg0XMyU";

    const viewer = new Cesium.Viewer("cesiumContainer", {
      terrainProvider: new Cesium.EllipsoidTerrainProvider(),
      baseLayerPicker: true
    });

    // Загрузка KML магнитной карты
    Cesium.IonResource.fromAssetId(3264517)
      .then((resource) => Cesium.KmlDataSource.load(resource))
      .then((dataSource) => viewer.dataSources.add(dataSource))
      .catch((error) => console.error("Ошибка загрузки KML:", error));

    // AR-функционал
    document.getElementById("arButton").addEventListener("click", async () => {
      if (!navigator.xr) {
        alert("WebXR не поддерживается на этом устройстве.");
        return;
      }

      try {
        const session = await navigator.xr.requestSession("immersive-ar", {
          requiredFeatures: ["local"]
        });

        const canvas = document.createElement("canvas");
        document.body.appendChild(canvas);
        const gl = canvas.getContext("webgl", { xrCompatible: true });

        await session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });

        session.addEventListener("end", () => {
          document.body.removeChild(canvas);
        });

        const refSpace = await session.requestReferenceSpace("local");

        session.requestAnimationFrame((time, frame) => {
          const pose = frame.getViewerPose(refSpace);
          if (pose) {
            const ctx = canvas.getContext("2d");
            ctx.fillStyle = "lime";
            ctx.fillRect(100, 100, 200, 200);
          }
        });
      } catch (e) {
        alert("Ошибка запуска AR: " + e.message);
      }
    });
  </script>
</body>
</html>
